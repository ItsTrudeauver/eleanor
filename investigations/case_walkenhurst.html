<!DOCTYPE html>
<html lang="en">

<head>
    <audio id="bgAudio" autoplay loop hidden>
        <source src="/assets/audio/cases/'It's In The Fog' by @DarrenCurtisMusic.mp3" type="audio/mpeg">
    </audio>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Case Board</title>
    <style>
        body {
            margin: 0;
            background: #1a1a1a;
            color: #fff;
            font-family: Arial, sans-serif;
            font-size: 0.8rem;
            height: 100vh;
            overflow: hidden;
        }

        #board {
            width: 100vw;
            height: 100vh;
            position: relative;
            background: radial-gradient(circle, #1a1a1a 0%, #000 100%);
        }

        .node {
            position: absolute;
            width: 200px;
            background: #222;
            border: 1px solid #444;
            border-radius: 4px;
            padding: 15px;
            cursor: grab;
            transition: box-shadow 0.3s;
        }

        .node:active {
            cursor: grabbing;
            box-shadow: 0 0 15px rgba(255, 68, 68, 0.5);
        }

        .node-header {
            color: #ff4444;
            margin-bottom: 10px;
            border-bottom: 1px solid #333;
            padding-bottom: 5px;
        }

        #connections {
            position: absolute;
            width: 100%;
            height: 100%;
            pointer-events: none;
        }

        .connector {
            stroke: #ff4444;
            stroke-width: 2;
            marker-end: url(#arrowhead);
        }

        #passwordPanel {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.8);
            padding: 15px;
            border-radius: 5px;
            border: 1px solid #ff4444;
        }

        #passwordInput {
            background: #333;
            border: 1px solid #444;
            color: #fff;
            padding: 8px;
            margin-right: 10px;
        }

        button {
            background: #ff4444;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 3px;
            cursor: pointer;
        }
    </style>
</head>

<body>
    <div id="board">
        <svg id="connections"></svg>

        <!-- Nodes will be added here dynamically -->
        <div class="node" data-id="1" style="top: 96px; left: 247px;">
            <div class="node-header">Walkenhurst was let go, 2054</div>
            <div class="node-content">Corporate announces he is looking for new ventures. I don't believe them. This was
                the exact same strategy they used to "fire" Fausten. </div>
        </div>
        <div class="node" data-id="2" style="top: 318px; left: 481px;">
            <div class="node-header">Relocation? 2054</div>
            <div class="node-content">He could have been a spike in their eyes, so they needed him gone but not in a way
                that would implicate them. Maybe he was exiled to somewhere else.
            </div>
        </div>
        <div class="node" data-id="3" style="top: 589px; left: 272px;">
            <div class="node-header">No public records</div>
            <div class="node-content">Checked in on his apartment. Car still there. No trace from bank account, no SMS
                activity. Just gone.
            </div>
        </div>
        <div class="node" data-id="4" style="top: 280px; left: 804px; width: 250px;">
            <div class="node-header">Reassignment of non-critical goods, 2055</div>
            <div class="node-content">
                <li>The Eye's outdated shipping logs.</li>
                <li>Full of stuff Rasmus worked on and with</li>
                <li>Undisclosed location. </li>
                <li>All by Pinwheel Transportations Co to the North West.</li>
                He's not still working <b>for them</b>, is he? <br>

            </div>
        </div>

        <div class="node" data-id="5" style="top: 519px; left: 654px;">
            <div class="node-header">Ghost neurocomputational model edits, 2055</div>
            <div class="node-content">
                Ghost contributor to The Open Eye, public repository of their tech as per agreement to anti-trust
                measures. Sensory input delays patches. Was this not Erasmus's obsession? It couldn't be...<br>
                The metadata of one of these edits pings a forgotten subnet per Fausten's deconstruction.
            </div>
        </div>

        <div class="node" data-id="6" style="top: 64px; left: 934px;">
            <div class="node-header">A Decommissioned Research Site? 2055</div>
            <div class="node-content">
                The ID formatting is distinctly Oculus, meaning this was before they rebranded. So this is one of the
                decommissioned sites?
            </div>
        </div>
        <div class="node" data-id="7" style="top: 528px; left: 1115px;">
            <div class="node-header">Electricity bill, 2056</div>
            <div class="node-content">
                This type of bill is from SuperWire Electricity, so why was it sent to Rasmus's home address?

            </div>
        </div>
        <div class="node" data-id="8" style="top: 312px; left: 91px;">
            <div class="node-header">Old Facility Address Search</div>
            <div class="node-content">
                They scrubbed the old facilities out of their address lists. This will take me forever to find where
                this ID was from.
            </div>
        </div>




    </div>

    <div id="passwordPanel">
        <input type="password" id="passwordInput" placeholder="this is the place...!!">
        <button onclick="validatePassword()">Verify</button>
        <div id="passwordMessage" style="margin-top: 10px; color: white; display: none;"></div>
    </div>

    <script>
        class DynamicBoard {
            constructor() {
                this.nodes = [];
                this.connections = new Map();
                this.draggingNode = null;
                this.offsetX = 0;
                this.offsetY = 0;

                this.initNodes();
                this.initConnections();
                this.setupEventListeners();
            }

            initNodes() {
                document.querySelectorAll('.node').forEach(node => {
                    this.nodes.push({
                        element: node,
                        id: node.dataset.id,
                        x: parseInt(node.style.left),
                        y: parseInt(node.style.top)
                    });
                });
            }

            initConnections() {
                // Define connections (from, to)
                const relationships = [[7, 2], [3, 8], [4, 1], [4, 8], [6, 5], [3, 2], [1, 6], [5, 7]];

                relationships.forEach(([from, to]) => {
                    this.createConnection(from, to);
                });
            }

            createConnection(fromId, toId) {
                const connectionId = `${fromId}-${toId}`;
                const svgNS = "http://www.w3.org/2000/svg";

                const line = document.createElementNS(svgNS, 'line');
                line.classList.add('connector');
                line.dataset.connection = connectionId;

                // Add arrowhead
                const defs = document.createElementNS(svgNS, 'defs');
                const marker = document.createElementNS(svgNS, 'marker');
                marker.id = 'arrowhead';
                marker.setAttribute('viewBox', '0 0 10 10');
                marker.setAttribute('refX', '9');
                marker.setAttribute('refY', '5');
                marker.setAttribute('markerWidth', '6');
                marker.setAttribute('markerHeight', '6');
                marker.setAttribute('orient', 'auto');

                const path = document.createElementNS(svgNS, 'path');
                path.setAttribute('d', 'M 0 0 L 10 5 L 0 10 z');
                path.setAttribute('fill', '#ff4444');
                marker.appendChild(path);
                defs.appendChild(marker);

                document.getElementById('connections').appendChild(defs);
                document.getElementById('connections').appendChild(line);

                this.connections.set(connectionId, line);
                this.updateConnectionPositions(fromId, toId);
            }

            updateConnectionPositions(fromId, toId) {
                const connectionId = `${fromId}-${toId}`;
                const line = this.connections.get(connectionId);

                const fromNode = this.nodes.find(n => n.id == fromId);
                const toNode = this.nodes.find(n => n.id == toId);

                if (!fromNode || !toNode) return;

                const fromRect = fromNode.element.getBoundingClientRect();
                const toRect = toNode.element.getBoundingClientRect();

                line.setAttribute('x1', fromRect.left + fromRect.width / 2);
                line.setAttribute('y1', fromRect.top + fromRect.height / 2);
                line.setAttribute('x2', toRect.left + toRect.width / 2);
                line.setAttribute('y2', toRect.top + toRect.height / 2);
            }

            setupEventListeners() {
                document.querySelectorAll('.node').forEach(node => {
                    node.addEventListener('mousedown', e => {
                        this.draggingNode = node;
                        const rect = node.getBoundingClientRect();
                        this.offsetX = e.clientX - rect.left;
                        this.offsetY = e.clientY - rect.top;
                    });
                });

                document.addEventListener('mousemove', e => {
                    if (this.draggingNode) {
                        const x = e.clientX - this.offsetX;
                        const y = e.clientY - this.offsetY;

                        this.draggingNode.style.left = `${x}px`;
                        this.draggingNode.style.top = `${y}px`;

                        // Update all connections for this node
                        const nodeId = this.draggingNode.dataset.id;
                        this.connections.forEach((line, connId) => {
                            const [fromId, toId] = connId.split('-');
                            if (fromId == nodeId || toId == nodeId) {
                                this.updateConnectionPositions(fromId, toId);
                            }
                        });
                    }
                });

                document.addEventListener('mouseup', () => {
                    this.draggingNode = null;
                });
            }
        }

        // Initialize the board
        new DynamicBoard();


        async function validatePassword() {
            const password = document.getElementById('passwordInput').value;
            const messageElement = document.getElementById('passwordMessage');

            try {
                const response = await fetch('/validate', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ password }),
                    credentials: 'include' // <<< This is crucial for cookies
                });

                const { valid } = await response.json();

                messageElement.style.display = 'block';
                messageElement.style.padding = '10px';
                messageElement.style.borderRadius = '4px';
                messageElement.style.textAlign = 'center';

                if (valid) {
                    messageElement.textContent = "That's it. I need to head there now!";
                    messageElement.style.backgroundColor = "#28a745";
                } else {
                    messageElement.textContent = "No...doesn't quite add up...";
                    messageElement.style.backgroundColor = "#dc3545";
                }

                // Auto-hide message after 3 seconds
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 3000);

            } catch (error) {
                console.error('Error:', error);

                // Show connection error
                messageElement.style.display = 'block';
                messageElement.textContent = "CONNECTION ERROR\nTRY AGAIN OFFLINE";
                messageElement.style.backgroundColor = "#ffc107"; // Yellow warning

                // Auto-hide message after 5 seconds
                setTimeout(() => {
                    messageElement.style.display = 'none';
                }, 5000);
            }
        }
    </script>
    <script>
        window.addEventListener("load", function () {
            const audio = document.getElementById("bgAudio"); // Use existing <audio> element
            audio.volume = 0; // Start with no sound
            const fadeInDuration = 3000; // 3 seconds fade-in
            const step = 0.01; // Volume increase step

            // Try to play the audio
            audio.play().then(() => {
                let fadeIn = setInterval(() => {
                    if (audio.volume < 0.3) {
                        audio.volume = Math.min(audio.volume + step, 1);
                    } else {
                        clearInterval(fadeIn); // Stop when max volume is reached
                    }
                }, fadeInDuration / (1 / step)); // Smoothly increase volume
            }).catch(error => console.log("Autoplay prevented:", error));
        });
    </script>


</body>

</html>